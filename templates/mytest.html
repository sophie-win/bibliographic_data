<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Publication Graphs</title>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    {#    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>#}
    <link rel="stylesheet" href="../static/css/bootstrap.min.css">
    <link rel="stylesheet" href="../static/css/font-awesome.min.css">
    <link rel="stylesheet" href="../static/css/neo4jd3.css?v=0.0.1">
    <style>
        body,
        html,
        .neo4jd3 {
            height: 100%;
            overflow: hidden;
        }
    </style>

    <script src="../static/js/d3.min.js"></script>
    <script src="../static/js/neo4jd3.js?v=0.0.1'"></script>
    <script>
        function init(data) {
            var neo4jd3 = new Neo4jd3('#neo4jd3', {
                    icons: {
// //
                    },
                    images: {
                        'Address': 'Apple',
//                        'Api': 'img/twemoji/1f527.svg',
                        'BirthDate': 'Apple',
                    },
                    text: {
                        'Cookie': "HELLO",
                    },
                    minCollision: 60,
                    nodeRadius: 25,
                    neo4jData: data,
                    zoomFit: false,
                    onNodeDoubleClick: function (node) {
                        $.ajax({
                            type: "GET",
                            url: "api/expand_more/",
                            data: {'node_id': node.id},
                            contentType: "application/json; charset=utf-8",
                            success: function (response) {
                                {#alert(JSON.stringify(response));#}
                                var d3_data = neo4jd3.neo4jDataToD3Data(response);
                                {#random_data = neo4jd3.randomD3Data(node, 5)#}
                                var nodes = d3_data.nodes;
                                var relationships = d3_data.relationships;
                                {#alert("hek " + JSON.stringify(d3_data) )#}

                                var del_index = [], del_rs_indexes = [];
                                data.results.forEach(function (result) {
                                    result.data.forEach(function (d) {
                                        nodes.forEach(function (return_node) {
                                            var actual_index = d.graph.nodes.findIndex(data => data.id === return_node.id);
                                            {#alert(actual_index + " " + return_node.id)#}
                                            if (actual_index >= 0) {
                                                var index = nodes.findIndex(n => n.id === return_node.id);
                                                del_index.push(index);

                                            } else {
                                                d.graph.nodes.push(return_node);
                                                {#alert('push' + JSON.stringify(return_node))#}
                                            }

                                        });
                                        relationships.forEach(function (rs) {
                                            var rs_actual_index = d.graph.relationships.findIndex(rel => rel.id === rs.id);
                                            if (rs_actual_index >=0 ){
                                                var rs_index = relationships.findIndex(r => r.id === rs.id);
                                                del_rs_indexes.push(rs_index);
                                            } else {
                                                d.graph.relationships.push(rs);
                                            }
                                        });

                                    });
                                });


//to eliminate the null value from deleted node
                                {#alert(del_index)#}
                                for (i = 0; i < del_index.length; i++) {
                                    delete nodes[del_index[i]];
                                    {#alert(nodes[del_index[i]]);#}
                                }

                                for (i = 0; i < del_rs_indexes.length; i++) {
                                    delete relationships[del_rs_indexes[i]];
                                    {#alert(nodes[del_index[i]]);#}
                                }

                                const j = JSON.stringify(d3_data, (k, v) => Array.isArray(v)
                                && !(v = v.filter(e => e)).length ? void 0 : v, 2);
                                {#alert(j)#}

                                {#document.getElementById("return_data").innerText = j;#}
                                neo4jd3.updateWithD3Data(JSON.parse(j))
                            },
                            error: function (xhr, ajaxOptions, thrownError) {
                                alert(xhr.status + thrownError.toString());
                                {#alert(thrownError.stackTrace);#}
                            }
                        });
                        var dd = {
                            "results": [{
                                "data": [{
                                    "graph": {
                                        "relationships": [{
                                            "startNode": node.id,
                                            "id": 12 + node.id,
                                            "type": "OWNS",
                                            "endNode": 10000
                                        }],
                                        "nodes": [{
                                            "id": node.id,
                                            "labels": [node.labels],
                                            "properties": node.properties
                                        }, {
                                            "id": "10000",
                                            "labels": ["Publication"],
                                            "properties": {
                                                "name_abbr": "Htet Aung",
                                            }
                                        }, {
                                            "id": "2452",
                                            "labels": ["Device"],
                                            "properties": {
                                                "name_abbr": "eisman"
                                            }
                                        }]
                                    }
                                }]
                            }]
                        };

                        {#neo4jd3.updateWithD3Data(random_data)#}
                    },
                    onRelationshipDoubleClick: function (relationship) {
                        console.log('double click on relationship: ' + JSON.stringify(relationship));
                    },
                }
                )
            ;
        }

        {#window.onload = init;#}

        $(function () {

            {#$("#includedContent").load("aa.html");#}

            $("#tags").autocomplete({
                {#source: availableTags,#}
                source: '/api/get_suggestions/',
                minLength: 1,
                select: function (event, ui) {

                    {#alert(ui.item.value)#}
                    {#AutoCompleteSelectHandler(event, ui)#}
                    GetJson(ui.item.name)
                    {#$("#project").val(ui.item.label);#}
                    {#$("#project-id").val(ui.item.value);#}
                    {#$("#project-description").html(ui.item.desc);#}
                    {#$("#project-icon").attr("src", "images/" + ui.item.icon);#}

                    return true;
                }
            }).autocomplete("instance")._renderItem = function (ul, item) {
                return $("<li>")
                    .append("<div> " + item.node_type + " <br>" + item.value + "</div>")
                    .appendTo(ul);
            };

            function AutoCompleteSelectHandler(event, ui) {
                var selectedObj = ui.item;
                alert(selectedObj.value)

            }

            function GetJson(term) {
                // Send an AJAX request
                $.ajax({
                    type: "GET",
                    url: "api/get_json_data/",
                    data: {'term': term},
                    contentType: "application/json; charset=utf-8",
                    success: function (response) {
                        {#var data = response;#}
                        {##}
                        {#var parsed = JSON.parse(data);#}
                        {#var data = jQuery.parseJSON(response);#}
                        {#alert(JSON.stringify(response));#}
                        {#init(JSON.stringify(response));#}
                        {#alert(response)#}
                        {#var data = {"results": [{"data": [{"graph": {"relationships": [{"startNode": 2, "type": "WRITES", "endNode": 2864}], "nodes": [{"id": 2864, "labels": ["Book"], "properties": {"volume_no": "", "issue_no": "", "no_of_author": "2", "year": "2018", "publication": "ACS nano", "name": "Announcing the 2018 ACS Nano Lectureship Awards", "publish_phase": "Final", "book_id": "2-s2.0-85042685102", "literature_type": "Article", "labels": ["Book"], "doi": "10.1021/acsnano.8b00282"}}, {"id": 2, "labels": ["Author"], "properties": {"name": "Fernandez, L.E", "labels": ["Author"]}}]}}]}]};#}
                        init(response)

                    },
                    error: function (xhr, ajaxOptions, thrownError) {
                        alert(xhr.status + thrownError.toString());
                        {#alert(thrownError.stackTrace);#}
                    }
                });
            }
        });
        {# function #}


    </script>
</head>
<body>
<div class="container">
  <h2>Dynamic Pills</h2>
  <p>To make the tabs toggleable, add the data-toggle="pill" attribute to each link. Then add a .tab-pane class with a unique ID for every tab and wrap them inside a div element with class .tab-content.</p>
  <ul class="nav nav-pills">
    <li class="active"><a data-toggle="pill" href="#home">Home</a></li>
    <li><a data-toggle="pill" href="#menu1">Menu 1</a></li>
    <li><a data-toggle="pill" href="#menu2">Menu 2</a></li>
    <li><a data-toggle="pill" href="#menu3">Menu 3</a></li>
  </ul>

{#<div id="includedContent"></div>#}
{#<div class="tab-content">#}
{#    <div class="tab-pane fade">#}
<div class="form-row">
    <div class="col">
        <input type="text" class="w-100 form-control-xs-lg search-input" id="tags" name="term"
               placeholder="Search Here..."
               style="width: 95%; padding:10px; margin-top: 50px; margin-left: 10px; margin-right: 10px">
    </div>
</div>
{#<div class="ui-widget">#}
{#    <input id="tags" placeholder="Searh Here...">#}
{##}
{#    <a href="{% url 'get_list' 'Article' %}">heys</a>#}
{#</div>#}
<br>
{#<p id="return_data">hello</p>#}


<div id="neo4jd3"></div>
{#    </div>#}
{##}
{#</div>#}
</body>
</html>